<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Step 2: Verify Cookie</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 20px;
      max-width: 600px;
      margin: 0 auto;
      background: #f5f5f5;
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin: 15px 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 { color: #333; font-size: 20px; }
    .result {
      padding: 20px;
      border-radius: 12px;
      margin: 15px 0;
      text-align: center;
    }
    .result.success { background: #d4edda; color: #155724; }
    .result.error { background: #f8d7da; color: #721c24; }
    .result.warning { background: #fff3cd; color: #856404; }
    pre {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 11px;
      text-align: left;
      word-break: break-all;
    }
    .emoji { font-size: 48px; margin-bottom: 10px; }
    .subtitle { font-size: 14px; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>ğŸ” Step 2: Verify Cookie (Safari)</h1>
  
  <div class="card">
    <p>è¿™ä¸ªé¡µé¢åœ¨ <strong>Safari</strong> ä¸­æ‰“å¼€ï¼Œç”¨äºéªŒè¯æ˜¯å¦èƒ½è¯»å–åˆ°æ­¥éª¤1 (ASWebAuthenticationSession) è®¾ç½®çš„ cookieã€‚</p>
  </div>

  <div id="resultCard" class="result warning">
    <div class="emoji">â³</div>
    <div>æ­£åœ¨æ£€æŸ¥ Cookie...</div>
  </div>

  <div class="card">
    <h3>Cookie è¯¦æƒ…:</h3>
    <pre id="details"></pre>
  </div>

  <script>
    function getUrlParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    // ä» URL è·å–æœŸæœ›çš„ cookie å€¼
    const expectedCookie = getUrlParam('expected');
    
    // è¯»å–æ‰€æœ‰ cookie
    const allCookies = document.cookie;
    
    // è§£æ cookie
    const cookieObj = {};
    if (allCookies) {
      allCookies.split(';').forEach(c => {
        const parts = c.trim().split('=');
        if (parts.length >= 2) {
          cookieObj[parts[0]] = parts.slice(1).join('=');
        }
      });
    }
    
    // æŸ¥æ‰¾æµ‹è¯• cookie
    const foundCookie = cookieObj['sso_test_cookie'];
    const isMatch = expectedCookie && foundCookie === expectedCookie;
    
    // æ›´æ–°ç»“æœæ˜¾ç¤º
    const resultCard = document.getElementById('resultCard');
    
    if (isMatch) {
      // å®Œå…¨åŒ¹é… - å…±äº«æˆåŠŸ
      resultCard.className = 'result success';
      resultCard.innerHTML = `
        <div class="emoji">âœ…</div>
        <div><strong>Cookie å…±äº«æˆåŠŸï¼</strong></div>
        <div class="subtitle">
          Safari æˆåŠŸè¯»å–åˆ° ASWebAuthenticationSession è®¾ç½®çš„ Cookie<br><br>
          <strong>è¿™è¯æ˜ SSO æ–¹æ¡ˆå¯è¡Œï¼</strong>
        </div>
      `;
    } else if (foundCookie) {
      // æ‰¾åˆ° cookie ä½†å€¼ä¸åŒ¹é… (å¯èƒ½æ˜¯ä¹‹å‰çš„æµ‹è¯•)
      resultCard.className = 'result warning';
      resultCard.innerHTML = `
        <div class="emoji">ğŸª</div>
        <div><strong>æ‰¾åˆ° Cookieï¼Œä½†å€¼ä¸åŒ¹é…</strong></div>
        <div class="subtitle">
          æ‰¾åˆ°: ${foundCookie}<br>
          æœŸæœ›: ${expectedCookie || '(æœªæä¾›)'}<br><br>
          å¯èƒ½æ˜¯ä¹‹å‰çš„æµ‹è¯•é—ç•™ï¼Œè¯·é‡æ–°æµ‹è¯•
        </div>
      `;
    } else {
      // æ²¡æœ‰æ‰¾åˆ° cookie - å…±äº«å¤±è´¥
      resultCard.className = 'result error';
      resultCard.innerHTML = `
        <div class="emoji">âŒ</div>
        <div><strong>Cookie å…±äº«å¤±è´¥</strong></div>
        <div class="subtitle">
          Safari æ— æ³•è¯»å–åˆ° ASWebAuthenticationSession è®¾ç½®çš„ Cookie<br><br>
          æœŸæœ›çš„ Cookie: ${expectedCookie || '(æœªæä¾›)'}
        </div>
      `;
    }
    
    // æ˜¾ç¤ºè¯¦æƒ…
    document.getElementById('details').textContent = JSON.stringify({
      expected: expectedCookie || '(not provided)',
      found: foundCookie || '(not found)',
      match: isMatch,
      allCookies: allCookies || '(no cookies)',
      parsedCookies: cookieObj,
      timestamp: new Date().toISOString()
    }, null, 2);
  </script>
</body>
</html>
