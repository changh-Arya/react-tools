<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>State API Test</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; 
      padding: 20px;
    }
    .container { 
      background: white; 
      border-radius: 16px; 
      padding: 24px; 
      max-width: 400px; 
      margin: 0 auto;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    h1 { color: #333; font-size: 20px; margin-bottom: 8px; text-align: center; }
    .subtitle { color: #666; font-size: 14px; text-align: center; margin-bottom: 20px; }
    .section { 
      background: #f8f9fa; 
      border-radius: 8px; 
      padding: 16px; 
      margin-bottom: 16px;
    }
    .section-title { font-weight: 600; color: #333; margin-bottom: 12px; font-size: 14px; }
    .log-item { 
      background: white; 
      border: 1px solid #e0e0e0; 
      border-radius: 6px; 
      padding: 10px; 
      margin-bottom: 8px; 
      font-size: 12px;
      word-break: break-all;
      font-family: monospace;
    }
    .log-success { border-left: 3px solid #00a650; }
    .log-error { border-left: 3px solid #dc3545; }
    .log-info { border-left: 3px solid #17a2b8; }
    .btn { 
      width: 100%; 
      padding: 14px; 
      border: none; 
      border-radius: 8px; 
      font-size: 15px; 
      font-weight: 600; 
      cursor: pointer; 
      margin-bottom: 10px;
      transition: all 0.2s;
    }
    .btn-primary { background: #00a650; color: white; }
    .btn-primary:active { background: #008c44; transform: scale(0.98); }
    .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
    .btn-info { background: #17a2b8; color: white; }
    .btn-warning { background: #ffc107; color: #333; }
    .btn-secondary { background: #6c757d; color: white; }
    .status { 
      text-align: center; 
      padding: 12px; 
      border-radius: 8px; 
      margin-bottom: 16px;
      font-size: 14px;
    }
    .status-waiting { background: #fff3cd; color: #856404; }
    .status-loading { background: #cce5ff; color: #004085; }
    .status-success { background: #d4edda; color: #155724; }
    .status-error { background: #f8d7da; color: #721c24; }
    .info { font-size: 12px; color: #666; margin-top: 16px; padding: 12px; background: #e9ecef; border-radius: 8px; }
    .state-display { 
      font-family: monospace; 
      font-size: 18px; 
      text-align: center;
      color: #00a650;
      background: #f8f9fa;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” State API Test</h1>
    <p class="subtitle">æµ‹è¯• /generate/state API å’Œ Cookie å…±äº«</p>
    
    <div id="status" class="status status-waiting">
      ç­‰å¾…å¼€å§‹æµ‹è¯•...
    </div>
    
    <div id="stateDisplay" class="state-display" style="display:none;">
      State: <span id="stateValue">-</span>
    </div>
    
    <div class="section">
      <div class="section-title">ğŸ“‹ æ“ä½œæ—¥å¿—</div>
      <div id="logs">
        <div class="log-item log-info">é¡µé¢å·²åŠ è½½ï¼Œç­‰å¾…æ“ä½œ...</div>
      </div>
    </div>
    
    <button id="btnGenerate" class="btn btn-primary" onclick="generateState()">
      ğŸ”‘ è°ƒç”¨ /generate/state API
    </button>
    
    <button id="btnCallback" class="btn btn-warning" onclick="callbackToApp()" disabled>
      ğŸ“± è¿”å› App (æºå¸¦ State)
    </button>
    
    <button class="btn btn-secondary" onclick="forceCallback()">
      ğŸ”™ å¼ºåˆ¶è¿”å› App (æ— è®ºæˆåŠŸå¤±è´¥)
    </button>
    
    <button class="btn btn-info" onclick="autoFlow()">
      ğŸš€ è‡ªåŠ¨å®Œæˆæµç¨‹ (ç”Ÿæˆ + å›è°ƒ)
    </button>
    
    <button class="btn btn-secondary" onclick="clearLogs()">
      ğŸ—‘ï¸ æ¸…é™¤æ—¥å¿—
    </button>
    
    <div class="info">
      <strong>æµ‹è¯•æµç¨‹:</strong><br>
      1. ç‚¹å‡»"è°ƒç”¨ /generate/state API"è·å– state<br>
      2. åç«¯ä¼šè®¾ç½® session cookie<br>
      3. ç‚¹å‡»"è¿”å› App"æºå¸¦ state<br>
      4. App è°ƒç”¨ /valid/state éªŒè¯ cookie<br>
      5. å¦‚æœéªŒè¯æˆåŠŸï¼Œè¯´æ˜ Cookie å…±äº«æ­£å¸¸ âœ…
    </div>
  </div>

  <script>
    // API é…ç½®
    const API_BASE = 'https://api.hkuat.manulife.com.hk/ext/hk-ado-root-web-app-env4';
    const GENERATE_STATE_URL = `${API_BASE}/generate/state`;
    
    // è§£æ URL å‚æ•°
    const urlParams = new URLSearchParams(window.location.search);
    const callbackScheme = urlParams.get('callbackScheme') || 'com.manulife.hk.uat.sam4';
    
    // å­˜å‚¨ç”Ÿæˆçš„ state
    let currentState = null;
    
    // æ—¥å¿—å·¥å…·
    function log(message, type = 'info') {
      const logsDiv = document.getElementById('logs');
      const time = new Date().toLocaleTimeString();
      const logClass = type === 'error' ? 'log-error' : (type === 'success' ? 'log-success' : 'log-info');
      const icon = type === 'error' ? 'âŒ' : (type === 'success' ? 'âœ…' : 'â„¹ï¸');
      
      logsDiv.innerHTML = `
        <div class="log-item ${logClass}">
          <strong>[${time}] ${icon}</strong> ${message}
        </div>
      ` + logsDiv.innerHTML;
      
      console.log(`[${type.toUpperCase()}] ${message}`);
    }
    
    function setStatus(message, type) {
      const statusDiv = document.getElementById('status');
      statusDiv.className = `status status-${type}`;
      statusDiv.innerHTML = message;
    }
    
    // è°ƒç”¨ /generate/state API
    async function generateState() {
      const btnGenerate = document.getElementById('btnGenerate');
      const btnCallback = document.getElementById('btnCallback');
      
      btnGenerate.disabled = true;
      setStatus('<span class="spinner"></span> æ­£åœ¨è°ƒç”¨ API...', 'loading');
      log(`è°ƒç”¨ API: ${GENERATE_STATE_URL}`);
      
      try {
        const response = await fetch(GENERATE_STATE_URL, {
          method: 'GET',
          credentials: 'include', // é‡è¦ï¼šå…è®¸æºå¸¦å’Œæ¥æ”¶ cookie
          headers: {
            'Accept': 'application/json, text/plain, */*'
          }
        });
        
        log(`HTTP çŠ¶æ€: ${response.status} ${response.statusText}`);
        
        // è®°å½•å“åº”å¤´ä¸­çš„ cookie ä¿¡æ¯
        const setCookie = response.headers.get('Set-Cookie');
        if (setCookie) {
          log(`æ”¶åˆ° Set-Cookie: ${setCookie}`, 'success');
        }
        
        // è·å–å“åº”å†…å®¹
        const contentType = response.headers.get('Content-Type') || '';
        let data;
        
        if (contentType.includes('application/json')) {
          data = await response.json();
          log(`JSON å“åº”: ${JSON.stringify(data)}`);
        } else {
          data = await response.text();
          log(`æ–‡æœ¬å“åº”: ${data}`);
        }
        
        // è§£æ state
        // å“åº”å¯èƒ½æ˜¯: "com.manulife.hk.uat.sam4:/?state=439b6bd2" æˆ– { callbackUrl: "..." } æˆ– { state: "..." }
        if (typeof data === 'string') {
          const match = data.match(/state=([^&]+)/);
          if (match) {
            currentState = decodeURIComponent(match[1]);
          } else {
            currentState = data;
          }
        } else if (typeof data === 'object') {
          if (data.state) {
            currentState = data.state;
          } else if (data.callbackUrl) {
            const match = data.callbackUrl.match(/state=([^&]+)/);
            if (match) {
              currentState = decodeURIComponent(match[1]);
            }
          }
        }
        
        if (currentState) {
          log(`æå–åˆ° State: ${currentState}`, 'success');
          document.getElementById('stateDisplay').style.display = 'block';
          document.getElementById('stateValue').textContent = currentState;
          setStatus('âœ… State ç”ŸæˆæˆåŠŸï¼Cookie å·²è®¾ç½®', 'success');
          btnCallback.disabled = false;
        } else {
          log('æ— æ³•ä»å“åº”ä¸­è§£æ state', 'error');
          setStatus('âš ï¸ API è¿”å›æˆåŠŸä½†æ— æ³•è§£æ state', 'error');
        }
        
      } catch (error) {
        log(`API è°ƒç”¨å¤±è´¥: ${error.message}`, 'error');
        setStatus(`âŒ API è°ƒç”¨å¤±è´¥: ${error.message}`, 'error');
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯ CORS é—®é¢˜
        if (error.message.includes('Failed to fetch')) {
          log('å¯èƒ½æ˜¯ CORS é—®é¢˜ï¼Œè¯·ç¡®ä¿ API å…è®¸è·¨åŸŸè¯·æ±‚', 'error');
        }
      } finally {
        btnGenerate.disabled = false;
      }
    }
    
    // è¿”å› App
    function callbackToApp() {
      if (!currentState) {
        log('æ²¡æœ‰å¯ç”¨çš„ stateï¼Œè¯·å…ˆç”Ÿæˆ', 'error');
        return;
      }
      
      const callbackUrl = `${callbackScheme}:/?state=${encodeURIComponent(currentState)}&source=state_api_test`;
      
      log(`å‡†å¤‡å›è°ƒåˆ° App: ${callbackUrl}`);
      setStatus('ğŸ“± æ­£åœ¨è¿”å› App...', 'loading');
      
      // è·³è½¬åˆ° URL scheme
      window.location.href = callbackUrl;
    }
    
    // å¼ºåˆ¶è¿”å› App (æ— è®ºæ˜¯å¦æœ‰ state)
    function forceCallback() {
      const stateToUse = currentState || 'test_' + Date.now();
      const status = currentState ? 'success' : 'no_state';
      
      const callbackUrl = `${callbackScheme}:/?state=${encodeURIComponent(stateToUse)}&source=force_callback&status=${status}`;
      
      log(`å¼ºåˆ¶å›è°ƒåˆ° App: ${callbackUrl}`);
      setStatus('ğŸ“± æ­£åœ¨è¿”å› App...', 'loading');
      
      // è·³è½¬åˆ° URL scheme
      window.location.href = callbackUrl;
    }
    
    // è‡ªåŠ¨å®Œæˆæµç¨‹
    async function autoFlow() {
      log('å¼€å§‹è‡ªåŠ¨æµç¨‹...', 'info');
      
      // 1. ç”Ÿæˆ state
      await generateState();
      
      // 2. ç­‰å¾…ä¸€ä¸‹è®©ç”¨æˆ·çœ‹åˆ°ç»“æœ
      if (currentState) {
        log('2ç§’åå°†è‡ªåŠ¨è¿”å› App...', 'info');
        setTimeout(() => {
          callbackToApp();
        }, 2000);
      }
    }
    
    // æ¸…é™¤æ—¥å¿—
    function clearLogs() {
      document.getElementById('logs').innerHTML = '<div class="log-item log-info">æ—¥å¿—å·²æ¸…é™¤</div>';
      document.getElementById('stateDisplay').style.display = 'none';
      document.getElementById('stateValue').textContent = '-';
      document.getElementById('btnCallback').disabled = true;
      currentState = null;
      setStatus('ç­‰å¾…å¼€å§‹æµ‹è¯•...', 'waiting');
    }
    
    // é¡µé¢åŠ è½½
    window.onload = async function() {
      log(`é¡µé¢å·²åŠ è½½ï¼ŒCallback Scheme: ${callbackScheme}`);
      log(`API URL: ${GENERATE_STATE_URL}`);
      
      // æ£€æŸ¥å½“å‰ cookies
      const cookies = document.cookie;
      if (cookies) {
        log(`å½“å‰é¡µé¢ Cookies: ${cookies.substring(0, 100)}${cookies.length > 100 ? '...' : ''}`);
      } else {
        log('å½“å‰é¡µé¢æ²¡æœ‰ cookies');
      }
      
      // æ£€æŸ¥æ˜¯å¦æ˜¯è‡ªåŠ¨æ¨¡å¼ (é»˜è®¤è‡ªåŠ¨)
      const autoMode = urlParams.get('auto') !== 'false';
      
      if (autoMode) {
        log('ğŸš€ è‡ªåŠ¨æ¨¡å¼å¯åŠ¨ï¼Œå¼€å§‹å®Œæ•´æµç¨‹...', 'info');
        setStatus('<span class="spinner"></span> è‡ªåŠ¨æ‰§è¡Œä¸­...', 'loading');
        
        // è‡ªåŠ¨æ‰§è¡Œï¼šç”Ÿæˆ state -> å›è°ƒ App
        await generateState();
        
        if (currentState) {
          log('âœ… State ç”ŸæˆæˆåŠŸï¼Œ1ç§’åè‡ªåŠ¨è¿”å› App...', 'success');
          setTimeout(() => {
            callbackToApp();
          }, 1000);
        } else {
          log('âŒ è‡ªåŠ¨æµç¨‹å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ“ä½œ', 'error');
          setStatus('âŒ è‡ªåŠ¨æµç¨‹å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ“ä½œ', 'error');
        }
      } else {
        log('æ‰‹åŠ¨æ¨¡å¼ï¼Œç­‰å¾…ç”¨æˆ·æ“ä½œ...', 'info');
      }
    };
  </script>
</body>
</html>
